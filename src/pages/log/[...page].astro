---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

export const getStaticPaths = (async ({ paginate }) => {
  // Get all works and sort by publishDate (most recent first)
  const allWorks = await getCollection('works');
  const sortedWorks = allWorks.sort((a, b) => {
    const dateA = new Date(a.data.publishDate || '2024-01-01');
    const dateB = new Date(b.data.publishDate || '2024-01-01');
    return dateB.getTime() - dateA.getTime();
  });

  // Paginate with 100 works per page
  return paginate(sortedWorks, { pageSize: 100 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// Group works by month for better readability
const worksByMonth = page.data.reduce((acc, work) => {
  const date = new Date(work.data.publishDate || '2024-01-01');
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

  if (!acc[monthKey]) {
    acc[monthKey] = [];
  }
  acc[monthKey].push(work);
  return acc;
}, {} as Record<string, typeof page.data>);

function formatDate(dateString: string | Date) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function getAuthorString(authors: string | string[]) {
  if (Array.isArray(authors)) {
    return authors.join(', ');
  }
  return authors;
}
---

<BaseLayout title={`Log${page.currentPage > 1 ? ` - Page ${page.currentPage}` : ''} - Recent Additions - Dhwani`}>
  <main>
    <article class="py-16 md:py-20 lg:py-24 px-6 md:px-8 lg:px-12">
      <div class="max-w-[880px] mx-auto">
        <h1 class="font-serif text-[clamp(2.75rem,7vw,4.5rem)] font-normal leading-[1.12] tracking-[-0.02em] text-ink mb-6">
          Log
        </h1>

        <p class="font-serif-body text-[1.05rem] md:text-[1.15rem] leading-[1.85] text-ink-light font-normal mb-12 max-w-[680px]">
          Recent additions to the Dhwani collection. {page.total} total works.
        </p>

        <div class="space-y-12">
          {Object.entries(worksByMonth).map(([month, works]) => (
            <section>
              <h2 class="font-serif text-[1.65rem] font-normal tracking-tight text-ink mb-6 pb-2 border-b border-ink/10">
                {month}
              </h2>

              <div class="space-y-4">
                {works.map((work) => (
                  <div class="group">
                    <div class="flex items-baseline gap-4 hover:bg-paper-light transition-colors -mx-3 px-3 py-2 rounded">
                      <time
                        class="font-mono text-[0.8rem] text-ink-lighter shrink-0 w-20"
                        datetime={work.data.publishDate}
                      >
                        {formatDate(work.data.publishDate)}
                      </time>

                      <div class="flex-1 min-w-0">
                        <a
                          href={`/works/${work.slug}`}
                          class="font-serif text-[1.05rem] text-ink hover:text-accent transition-colors"
                        >
                          {work.data.title}
                        </a>

                        <div class="font-serif-body text-[0.9rem] text-ink-lighter mt-0.5">
                          {getAuthorString(work.data.author)}
                          {work.data.year && <span class="text-ink-lightest"> · {work.data.year}</span>}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>

        <!-- Pagination Controls -->
        <nav class="mt-16 pt-8 border-t border-ink/10" aria-label="Pagination">
          <div class="flex items-center justify-between">
            <p class="font-serif-body text-[0.95rem] text-ink-lighter">
              Showing {page.start + 1}–{page.end + 1} of {page.total} works
            </p>

            <div class="flex gap-2">
              {page.url.prev && (
                <a
                  href={page.url.prev}
                  class="px-4 py-2 font-serif-body text-[0.9rem] text-ink hover:text-accent border border-ink/20 hover:border-accent/30 rounded transition-colors"
                >
                  ← Previous
                </a>
              )}

              <span class="px-4 py-2 font-serif-body text-[0.9rem] text-ink-lighter">
                Page {page.currentPage} of {page.lastPage}
              </span>

              {page.url.next && (
                <a
                  href={page.url.next}
                  class="px-4 py-2 font-serif-body text-[0.9rem] text-ink hover:text-accent border border-ink/20 hover:border-accent/30 rounded transition-colors"
                >
                  Next →
                </a>
              )}
            </div>
          </div>
        </nav>
      </div>
    </article>
  </main>
</BaseLayout>

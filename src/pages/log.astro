---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// Get all works and sort by publishDate (most recent first)
const allWorks = await getCollection('works');
const sortedWorks = allWorks.sort((a, b) => {
  const dateA = new Date(a.data.publishDate || '2024-01-01');
  const dateB = new Date(b.data.publishDate || '2024-01-01');
  return dateB.getTime() - dateA.getTime();
});

// Take only the most recent 100 works
const recentWorks = sortedWorks.slice(0, 100);

// Group works by month for better readability
const worksByMonth = recentWorks.reduce((acc, work) => {
  const date = new Date(work.data.publishDate || '2024-01-01');
  const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

  if (!acc[monthKey]) {
    acc[monthKey] = [];
  }
  acc[monthKey].push(work);
  return acc;
}, {} as Record<string, typeof recentWorks>);

function formatDate(dateString: string | Date) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function getAuthorString(authors: string | string[]) {
  if (Array.isArray(authors)) {
    return authors.join(', ');
  }
  return authors;
}
---

<BaseLayout title="Log - Recent Additions - Dhwani">
  <main>
    <article class="py-16 md:py-20 lg:py-24 px-6 md:px-8 lg:px-12">
      <div class="max-w-[880px] mx-auto">
        <h1 class="font-serif text-[clamp(2.75rem,7vw,4.5rem)] font-normal leading-[1.12] tracking-[-0.02em] text-ink mb-6">
          Log
        </h1>

        <p class="font-serif-body text-[1.05rem] md:text-[1.15rem] leading-[1.85] text-ink-light font-normal mb-12 max-w-[680px]">
          Recent additions to the Dhwani collection. Showing the most recent 100 works added.
        </p>

        <div class="space-y-12">
          {Object.entries(worksByMonth).map(([month, works]) => (
            <section>
              <h2 class="font-serif text-[1.65rem] font-normal tracking-tight text-ink mb-6 pb-2 border-b border-ink/10">
                {month}
              </h2>

              <div class="space-y-4">
                {works.map((work) => (
                  <div class="group">
                    <div class="flex items-baseline gap-4 hover:bg-paper-light transition-colors -mx-3 px-3 py-2 rounded">
                      <time
                        class="font-mono text-[0.8rem] text-ink-lighter shrink-0 w-20"
                        datetime={work.data.publishDate}
                      >
                        {formatDate(work.data.publishDate)}
                      </time>

                      <div class="flex-1 min-w-0">
                        <a
                          href={`/works/${work.slug}`}
                          class="font-serif text-[1.05rem] text-ink hover:text-accent transition-colors"
                        >
                          {work.data.title}
                        </a>

                        <div class="font-serif-body text-[0.9rem] text-ink-lighter mt-0.5">
                          {getAuthorString(work.data.author)}
                          {work.data.year && <span class="text-ink-lightest"> Â· {work.data.year}</span>}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>

        <div class="mt-16 pt-8 border-t border-ink/10">
          <p class="font-serif-body text-[0.95rem] text-ink-lighter">
            Showing {recentWorks.length} most recent additions out of {allWorks.length} total works in the collection.
          </p>
        </div>
      </div>
    </article>
  </main>
</BaseLayout>
